<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ğŸ¬ Video Merger</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background: #0f0f13; color: #e8e8f0; min-height: 100vh; display: flex; flex-direction: column; align-items: center; padding: 40px 20px; }
    h1 { font-size: 2rem; font-weight: 700; margin-bottom: 6px; background: linear-gradient(135deg, #a78bfa, #60a5fa); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
    .subtitle { color: #888; font-size: 0.9rem; margin-bottom: 12px; }
    .container { width: 100%; max-width: 700px; }
    #dropzone { border: 2px dashed #3a3a5c; border-radius: 16px; padding: 48px 20px; text-align: center; cursor: pointer; transition: all 0.2s; background: #16161f; margin-bottom: 24px; }
    #dropzone:hover, #dropzone.drag-over { border-color: #a78bfa; background: #1e1e2e; }
    #dropzone .icon { font-size: 2.5rem; margin-bottom: 12px; }
    #dropzone p { color: #888; font-size: 0.95rem; }
    #dropzone strong { color: #c4b5fd; }
    #fileInput { display: none; }
    #videoList { display: flex; flex-direction: column; gap: 10px; margin-bottom: 24px; }
    .video-item { display: flex; align-items: center; gap: 12px; background: #16161f; border: 1px solid #2a2a40; border-radius: 12px; padding: 12px 16px; cursor: grab; transition: all 0.15s; user-select: none; }
    .video-item:active { cursor: grabbing; }
    .video-item.dragging { opacity: 0.4; border-color: #a78bfa; }
    .video-item.drag-target { border-color: #60a5fa; background: #1a1a2e; }
    .drag-handle { font-size: 1.1rem; color: #555; flex-shrink: 0; }
    .video-thumb { font-size: 1.5rem; flex-shrink: 0; }
    .video-info { flex: 1; min-width: 0; }
    .video-name { font-size: 0.9rem; font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .video-size { font-size: 0.75rem; color: #666; margin-top: 2px; }
    .order-badge { background: #2a2a40; color: #a78bfa; font-size: 0.75rem; font-weight: 700; padding: 2px 8px; border-radius: 20px; flex-shrink: 0; }
    .remove-btn { background: none; border: none; color: #555; cursor: pointer; font-size: 1rem; padding: 4px; border-radius: 6px; transition: color 0.15s; flex-shrink: 0; }
    .remove-btn:hover { color: #f87171; }
    .controls { display: flex; gap: 12px; margin-bottom: 24px; }
    .btn { flex: 1; padding: 14px 20px; border-radius: 10px; font-size: 0.95rem; font-weight: 600; border: none; cursor: pointer; transition: all 0.2s; }
    .btn-primary { background: linear-gradient(135deg, #7c3aed, #3b82f6); color: white; }
    .btn-primary:hover:not(:disabled) { transform: translateY(-1px); box-shadow: 0 8px 24px rgba(124,58,237,0.35); }
    .btn-primary:disabled { opacity: 0.4; cursor: not-allowed; transform: none; }
    .btn-secondary { background: #1e1e2e; color: #888; border: 1px solid #2a2a40; }
    .btn-secondary:hover { background: #252535; color: #ccc; }

    /* Progress */
    #progressSection { display: none; background: #16161f; border: 1px solid #2a2a40; border-radius: 12px; padding: 20px; margin-bottom: 24px; }
    .progress-label { font-size: 0.85rem; color: #888; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; }
    .progress-label span:first-child { flex: 1; }
    .progress-pct { font-variant-numeric: tabular-nums; font-weight: 600; color: #a78bfa; min-width: 38px; text-align: right; }
    .progress-bar { height: 8px; background: #2a2a40; border-radius: 10px; overflow: hidden; position: relative; }
    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #7c3aed, #3b82f6);
      border-radius: 10px;
      /* transiÃ§Ã£o suave â€” CSS faz a animaÃ§Ã£o, JS sÃ³ define o target */
      transition: width 0.8s ease-out;
      width: 0%;
      position: relative;
    }
    /* Shimmer animado por cima da barra */
    .progress-fill::after {
      content: '';
      position: absolute;
      top: 0; left: -60%;
      width: 60%; height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.25), transparent);
      animation: shimmer 1.4s infinite;
    }
    @keyframes shimmer { to { left: 160%; } }

    /* Etapas visuais */
    .steps { display: flex; gap: 0; margin-top: 14px; }
    .step { flex: 1; text-align: center; font-size: 0.7rem; color: #444; padding-top: 8px; position: relative; transition: color 0.3s; }
    .step::before {
      content: '';
      display: block;
      width: 10px; height: 10px;
      border-radius: 50%;
      background: #2a2a40;
      border: 2px solid #3a3a5c;
      margin: 0 auto 6px;
      transition: all 0.4s;
    }
    .step.active::before { background: #7c3aed; border-color: #a78bfa; box-shadow: 0 0 8px #a78bfa88; }
    .step.done::before { background: #22c55e; border-color: #4ade80; }
    .step.active { color: #c4b5fd; }
    .step.done { color: #4ade80; }

    /* Connector lines between steps */
    .step + .step::after {
      content: '';
      position: absolute;
      top: 12px; right: 50%;
      width: calc(100% - 10px);
      height: 2px;
      background: #2a2a40;
      z-index: 0;
      left: calc(-50% + 5px);
    }

    .log-output { margin-top: 14px; font-size: 0.75rem; color: #555; font-family: monospace; max-height: 60px; overflow-y: auto; line-height: 1.6; }

    #resultSection { display: none; background: #0f1f1a; border: 1px solid #134e4a; border-radius: 12px; padding: 20px; text-align: center; }
    #resultSection h3 { color: #34d399; margin-bottom: 6px; }
    #resultSection p { color: #6b8c85; font-size: 0.85rem; margin-bottom: 16px; }
    .btn-download { background: linear-gradient(135deg, #065f46, #0891b2); color: white; padding: 12px 32px; border-radius: 10px; font-size: 0.95rem; font-weight: 600; border: none; cursor: pointer; text-decoration: none; display: inline-block; transition: all 0.2s; }
    .btn-download:hover { transform: translateY(-1px); }
    .hint { font-size: 0.8rem; color: #555; text-align: center; margin-top: 16px; }
    .badge { display: inline-block; font-size: 0.75rem; padding: 4px 12px; border-radius: 20px; margin-bottom: 20px; }
    .badge-ok { background: #1a2e1a; color: #4ade80; border: 1px solid #166534; }
    .badge-warn { background: #2a1a0a; color: #fb923c; border: 1px solid #7c3a00; }
    ::-webkit-scrollbar { width: 4px; } ::-webkit-scrollbar-track { background: transparent; } ::-webkit-scrollbar-thumb { background: #3a3a5c; border-radius: 4px; }
  </style>
</head>
<body>

<script>
(function() {
  if (window.crossOriginIsolated) return;
  if (!('serviceWorker' in navigator)) return;
  const SW = `
    self.addEventListener('install', () => self.skipWaiting());
    self.addEventListener('activate', e => e.waitUntil(self.clients.claim()));
    self.addEventListener('fetch', event => {
      if (event.request.cache === 'only-if-cached' && event.request.mode !== 'same-origin') return;
      event.respondWith(
        fetch(event.request, {credentials:'include'}).then(res => {
          if (!res || res.status === 0 || res.type === 'opaque') return res;
          const h = new Headers(res.headers);
          h.set('Cross-Origin-Opener-Policy','same-origin');
          h.set('Cross-Origin-Embedder-Policy','require-corp');
          h.set('Cross-Origin-Resource-Policy','cross-origin');
          return new Response(res.body, {status:res.status, statusText:res.statusText, headers:h});
        }).catch(() => fetch(event.request))
      );
    });
  `;
  const blob = new Blob([SW], {type:'text/javascript'});
  const url = URL.createObjectURL(blob);
  navigator.serviceWorker.register(url, {scope: './'}).then(reg => {
    const worker = reg.installing || reg.waiting || reg.active;
    if (reg.active && !reg.installing && !reg.waiting) {
      if (!sessionStorage.getItem('coi-reload')) { sessionStorage.setItem('coi-reload','1'); window.location.reload(); }
      return;
    }
    worker.addEventListener('statechange', function() {
      if (this.state === 'activated') {
        if (!sessionStorage.getItem('coi-reload')) { sessionStorage.setItem('coi-reload','1'); window.location.reload(); }
      }
    });
  }).catch(e => console.warn('[COI-SW]', e));
})();
</script>

  <h1>ğŸ¬ Video Merger</h1>
  <p class="subtitle">Junte vÃ­deos MP4 na ordem que quiser â€” rÃ¡pido, sem upload, sem software</p>
  <div id="statusBadge"></div>

  <div class="container">
    <div id="dropzone" onclick="document.getElementById('fileInput').click()">
      <div class="icon">ğŸ“</div>
      <p><strong>Clique aqui</strong> ou arraste os vÃ­deos MP4</p>
      <p style="margin-top:6px;font-size:0.8rem;">Suporta mÃºltiplos arquivos</p>
    </div>
    <input type="file" id="fileInput" accept="video/*" multiple />
    <div id="videoList"></div>
    <div class="controls" id="controls" style="display:none;">
      <button class="btn btn-secondary" onclick="clearAll()">ğŸ—‘ Limpar</button>
      <button class="btn btn-primary" id="mergeBtn" onclick="startMerge()">âœ¨ Juntar VÃ­deos</button>
    </div>

    <div id="progressSection">
      <div class="progress-label">
        <span id="progressStatus">Processando...</span>
        <span class="progress-pct" id="progressPercent">0%</span>
      </div>
      <div class="progress-bar">
        <div class="progress-fill" id="progressFill"></div>
      </div>

      <!-- Etapas visuais -->
      <div class="steps">
        <div class="step" id="step-load">Carregando</div>
        <div class="step" id="step-concat">Juntando</div>
        <div class="step" id="step-done">Pronto</div>
      </div>

      <div class="log-output" id="logOutput" style="display:none"></div>
    </div>

    <div id="resultSection">
      <h3>âœ… Pronto!</h3>
      <p id="resultInfo">VÃ­deo gerado com sucesso.</p>
      <a id="downloadLink" class="btn-download" download="video-final.mp4">â¬‡ Baixar VÃ­deo Final</a>
    </div>
    <p class="hint">ğŸ’¡ Arraste os itens para reordenar antes de juntar</p>
  </div>

  <script src="https://unpkg.com/@ffmpeg/ffmpeg@0.11.6/dist/ffmpeg.min.js"></script>
  <script>
    const badge = document.getElementById('statusBadge');
    if (window.crossOriginIsolated) {
      badge.innerHTML = '<span class="badge badge-ok">ğŸ”’ Modo seguro ativo</span>';
    } else {
      badge.innerHTML = '<span class="badge badge-warn">â³ Ativando modo seguro... recarregue se travar</span>';
    }

    let videoFiles = [], dragSrcIndex = null, resultURL = null;
    const dropzone = document.getElementById('dropzone');
    const fileInput = document.getElementById('fileInput');
    dropzone.addEventListener('dragover', e => { e.preventDefault(); dropzone.classList.add('drag-over'); });
    dropzone.addEventListener('dragleave', () => dropzone.classList.remove('drag-over'));
    dropzone.addEventListener('drop', e => { e.preventDefault(); dropzone.classList.remove('drag-over'); addFiles([...e.dataTransfer.files]); });
    fileInput.addEventListener('change', e => addFiles([...e.target.files]));

    function addFiles(files) {
      files.filter(f => f.type.startsWith('video/') || f.name.match(/\.(mp4|mov|avi|webm|mkv)$/i)).forEach(f => videoFiles.push(f));
      renderList();
    }
    function renderList() {
      document.getElementById('controls').style.display = videoFiles.length > 0 ? 'flex' : 'none';
      document.getElementById('videoList').innerHTML = videoFiles.map((f,i) => `
        <div class="video-item" draggable="true" ondragstart="dragStart(event,${i})" ondragover="dragOver(event,${i})" ondrop="dragDrop(event,${i})" ondragend="dragEnd()" id="item-${i}">
          <span class="drag-handle">â˜°</span><span class="video-thumb">ğŸ¥</span>
          <div class="video-info">
            <div class="video-name">${escHtml(f.name)}</div>
            <div class="video-size">${formatSize(f.size)}</div>
          </div>
          <span class="order-badge">#${i+1}</span>
          <button class="remove-btn" onclick="removeVideo(${i})">âœ•</button>
        </div>`).join('');
    }
    function escHtml(s) { return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
    function formatSize(b) { return b<1048576?(b/1024).toFixed(1)+' KB':(b/1048576).toFixed(1)+' MB'; }
    function removeVideo(i) { videoFiles.splice(i,1); renderList(); }
    function clearAll() {
      videoFiles = [];
      if (resultURL) URL.revokeObjectURL(resultURL); resultURL = null;
      document.getElementById('resultSection').style.display = 'none';
      document.getElementById('progressSection').style.display = 'none';
      renderList(); fileInput.value = '';
    }
    function dragStart(e,i) { dragSrcIndex=i; document.getElementById(`item-${i}`).classList.add('dragging'); }
    function dragOver(e,i) { e.preventDefault(); document.querySelectorAll('.video-item').forEach(el=>el.classList.remove('drag-target')); document.getElementById(`item-${i}`)?.classList.add('drag-target'); }
    function dragDrop(e,i) { e.preventDefault(); if(dragSrcIndex===null||dragSrcIndex===i) return; const m=videoFiles.splice(dragSrcIndex,1)[0]; videoFiles.splice(i,0,m); renderList(); }
    function dragEnd() { dragSrcIndex=null; document.querySelectorAll('.video-item').forEach(el=>el.classList.remove('dragging','drag-target')); }

    // â”€â”€â”€ Progress suave â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    let _currentPct = 0;     // valor atual exibido
    let _targetPct  = 0;     // valor para onde estamos indo
    let _ceilPct    = 100;   // teto: nÃ£o avanÃ§a alÃ©m desse valor atÃ© o prÃ³ximo marco
    let _driftTimer = null;  // timer de drift lento

    // Define um novo alvo (pode ser chamado pelo FFmpeg ou pelos marcos do cÃ³digo)
    function setTarget(pct, ceil) {
      _targetPct = Math.min(pct, ceil !== undefined ? ceil : _ceilPct);
      if (ceil !== undefined) _ceilPct = ceil;
    }

    // Inicia o loop de animaÃ§Ã£o
    function startDrift() {
      if (_driftTimer) return;
      _driftTimer = setInterval(() => {
        if (_currentPct >= _targetPct) return;
        // avanÃ§a no mÃ¡ximo 0.4% por tick (suave), desacelera perto do teto
        const gap = _targetPct - _currentPct;
        const step = Math.max(0.05, Math.min(0.4, gap * 0.04));
        _currentPct = Math.min(_currentPct + step, _targetPct);
        renderProgress();
      }, 80);
    }

    function stopDrift() {
      if (_driftTimer) { clearInterval(_driftTimer); _driftTimer = null; }
    }

    // "Empurra" o alvo lentamente durante uma etapa que nÃ£o reporta progresso
    // AvanÃ§a atÃ© `until` ao longo de `durationMs` ms
    function slowCrawl(from, until, durationMs) {
      _currentPct = Math.max(_currentPct, from);
      _targetPct  = from;
      _ceilPct    = until;
      const steps = durationMs / 80;
      const increment = (until - from) / steps;
      let tick = 0;
      const crawlTimer = setInterval(() => {
        tick++;
        _targetPct = Math.min(from + increment * tick, until - 0.5); // para um pouco antes do teto
        if (tick >= steps) clearInterval(crawlTimer);
      }, 80);
      return crawlTimer;
    }

    function jumpTo(pct, status, stepId) {
      _currentPct = pct;
      _targetPct  = pct;
      renderProgress(status, stepId);
    }

    function renderProgress(status, stepId) {
      const pct = Math.round(_currentPct);
      document.getElementById('progressFill').style.width = pct + '%';
      document.getElementById('progressPercent').textContent = pct + '%';
      if (status) document.getElementById('progressStatus').textContent = status;
    }

    function setStep(id) {
      document.querySelectorAll('.step').forEach(el => { el.classList.remove('active'); });
      const el = document.getElementById('step-'+id);
      if (el) el.classList.add('active');
    }

    function doneStep(id) {
      const el = document.getElementById('id-'+id) || document.getElementById('step-'+id);
      if (el) { el.classList.remove('active'); el.classList.add('done'); }
    }

    function resetSteps() {
      document.querySelectorAll('.step').forEach(el => el.classList.remove('active','done'));
    }
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    function log(msg) {
      const out = document.getElementById('logOutput');
      out.textContent += msg + '\n';
      out.scrollTop = out.scrollHeight;
    }

    async function startMerge() {
      if (videoFiles.length < 2) { alert('Adicione pelo menos 2 vÃ­deos.'); return; }
      if (!window.crossOriginIsolated) {
        alert('O modo seguro ainda estÃ¡ sendo ativado. Recarregue a pÃ¡gina e tente novamente.');
        return;
      }

      const mergeBtn = document.getElementById('mergeBtn');
      mergeBtn.disabled = true;
      document.getElementById('progressSection').style.display = 'block';
      document.getElementById('resultSection').style.display = 'none';

      // Reset
      _currentPct = 0; _targetPct = 0; _ceilPct = 100;
      resetSteps();
      document.getElementById('logOutput').textContent = '';
      renderProgress('Carregando FFmpeg...');
      startDrift();

      try {
        const { createFFmpeg, fetchFile } = FFmpeg;

        // â”€â”€ Etapa 1: Carregar FFmpeg (0â†’8%) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        setStep('load');
        let crawl = slowCrawl(0, 8, 8000); // estima 8s para carregar

        const ffmpeg = createFFmpeg({
          corePath: 'https://unpkg.com/@ffmpeg/core@0.11.0/dist/ffmpeg-core.js',
          log: false,
          logger: ({type, message}) => {
            if (type === 'fferr' && (message.includes('Error') || message.includes('error') || message.includes('Invalid') || message.includes('failed'))) {
              log('âš  ' + message);
            }
          },
          progress: ({ratio}) => {
            // SÃ³ chega aqui durante o concat final (etapa 3, 60â†’94%)
            if (ratio > 0) {
              _targetPct = Math.min(94, 60 + ratio * 34);
              _ceilPct = 94;
            }
          }
        });

        await ffmpeg.load();
        clearInterval(crawl);
        log('FFmpeg pronto!');
        doneStep('load');

        // â”€â”€ Etapa 2: Carregar arquivos (8â†’25%) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        setStep('load');
        jumpTo(8, 'Carregando vÃ­deos...');
        const rawNames = [];
        const perFile = 17 / videoFiles.length;
        for (let i = 0; i < videoFiles.length; i++) {
          crawl = slowCrawl(8 + i * perFile, 8 + (i + 1) * perFile, 2000);
          const fname = `raw${i}.mp4`;
          rawNames.push(fname);
          ffmpeg.FS('writeFile', fname, await fetchFile(videoFiles[i]));
          clearInterval(crawl);
          jumpTo(8 + (i + 1) * perFile, `Carregando ${i+1}/${videoFiles.length}...`);
          log(`âœ“ ${videoFiles[i].name}`);
        }
        doneStep('load');

        // â”€â”€ Etapa 3: Juntar (25â†’94%) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        // Passo 3a: normaliza cada vÃ­deo individualmente (mais estÃ¡vel que inline)
        setStep('concat');
        jumpTo(25, 'Preparando vÃ­deos...');

        const normNames = [];
        const perNorm = 50 / rawNames.length;
        for (let i = 0; i < rawNames.length; i++) {
          const from = 25 + i * perNorm;
          const to   = 25 + (i + 1) * perNorm;
          crawl = slowCrawl(from, to, 30000);
          renderProgress(`Preparando ${i+1}/${rawNames.length}...`);
          log(`Preparando ${i+1}/${rawNames.length}: ${videoFiles[i].name}`);

          const normName = `norm${i}.mp4`;
          normNames.push(normName);

          await ffmpeg.run(
            '-i', rawNames[i],
            '-vf', 'fps=30,setsar=1',
            '-c:v', 'libx264', '-preset', 'ultrafast', '-crf', '23',
            '-c:a', 'aac', '-b:a', '128k', '-ar', '44100', '-ac', '2',
            normName
          );

          // Verifica se o arquivo foi gerado
          let ok = false;
          try { ok = ffmpeg.FS('readFile', normName).length > 1000; } catch(e) {}
          if (!ok) throw new Error(`Falha ao processar vÃ­deo ${i+1} (${videoFiles[i].name})`);

          clearInterval(crawl);
          jumpTo(to);
          log(`âœ“ ${videoFiles[i].name}`);
        }

        // Passo 3b: concatena via concat demuxer (mais estÃ¡vel que filter_complex)
        jumpTo(75, 'Juntando...');
        log('Concatenando...');
        crawl = slowCrawl(75, 93, 20000);

        const listContent = normNames.map(f => `file '${f}'`).join('\n');
        ffmpeg.FS('writeFile', 'list.txt', new TextEncoder().encode(listContent));

        await ffmpeg.run(
          '-f', 'concat', '-safe', '0', '-i', 'list.txt',
          '-c:v', 'libx264', '-preset', 'ultrafast', '-crf', '23',
          '-c:a', 'aac', '-b:a', '128k',
          '-vsync', 'cfr',
          '-movflags', '+faststart',
          'out.mp4'
        );

        try { ffmpeg.FS('unlink', 'list.txt'); } catch(e) {}

        clearInterval(crawl);

        // Verifica se out.mp4 foi gerado
        let outOk = false;
        try { outOk = ffmpeg.FS('readFile', 'out.mp4').length > 1000; } catch(e) {}
        if (!outOk) throw new Error('Falha ao gerar o vÃ­deo final. Verifique se os vÃ­deos sÃ£o MP4 vÃ¡lidos.');

        doneStep('concat');

        // â”€â”€ Etapa 4: Finalizar (94â†’100%) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        setStep('done');
        crawl = slowCrawl(94, 100, 1500);
        renderProgress('Finalizando...');

        const data = ffmpeg.FS('readFile', 'out.mp4');
        const blob = new Blob([data.buffer], {type: 'video/mp4'});
        if (resultURL) URL.revokeObjectURL(resultURL);
        resultURL = URL.createObjectURL(blob);
        [...rawNames, ...(typeof normNames !== 'undefined' ? normNames : []), 'out.mp4'].forEach(f => { try { ffmpeg.FS('unlink', f); } catch(e) {} });

        clearInterval(crawl);
        stopDrift();
        jumpTo(100, 'Pronto! âœ…');
        doneStep('done');

        document.getElementById('downloadLink').href = resultURL;
        document.getElementById('resultInfo').textContent = `${videoFiles.length} vÃ­deos juntados â€¢ ${(blob.size/1048576).toFixed(1)} MB`;
        document.getElementById('resultSection').style.display = 'block';
        log('ConcluÃ­do!');

      } catch(err) {
        stopDrift();
        console.error(err);
        log('ERRO: ' + err.message);
        alert('Erro: ' + err.message);
      } finally {
        mergeBtn.disabled = false;
      }
    }
  </script>
</body>
</html>
